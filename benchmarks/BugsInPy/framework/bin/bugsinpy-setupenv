#!/usr/bin/env bash

usage="-w work_dir
             The working directory to compile the project. Default will be the current directory.
"

case $1 in
 -[h?] | --help)
    cat <<-____HALP
        Usage: ${0##*/} [ --help ]
        $usage
____HALP
        exit 0;;
esac

###Read the flag of checkout
while getopts p:i:v:w: flag
do
    case "${flag}" in
        w) work_dir=${OPTARG};;
    esac
done

###Update the work directory
if [ "$work_dir" == "" ]; then 
   work_dir=$(pwd)
fi

if [[ $work_dir == */ ]]; then 
   temp_work_dir="$work_dir"
   work_dir=${temp_work_dir::-1}
fi

###Check work directory 
if [[ ! -e "$work_dir/bugsinpy_bug.info" ]]; then
   echo "This is not a checkout project folder"
   exit 1
elif [[ ! -e "$work_dir/bugsinpy_requirements.txt" ]]; then
   echo "This is not a checkout project folder"
   exit 1
elif [[ ! -e "$work_dir/bugsinpy_run_test.sh" ]]; then
   echo "This is not a checkout project folder"
   exit 1
fi

cd "$work_dir"

###Get parent directory
parent_dir=$(dirname "$work_dir")

###Add environment if it doesn't exist
if [ ! -d "$parent_dir/env" ]; then
  python3 -m venv "$parent_dir/env"
fi

###Activate environment
if [ -d "$parent_dir/env/Scripts" ]; then
  source "$parent_dir/env/Scripts/activate"
else
  check_dos2unix=$(dos2unix --version 2>&1)
	if [ "$check_dos2unix" == *"not found"* ]; then
	   echo "Please install dos2unix (sudo apt-get dos2unix)"
	   exit 1
	fi
  source "$parent_dir/env/bin/activate"
  dos2unix "$work_dir/bugsinpy_requirements.txt"
fi

###Read setup.sh
  run_setup_all=""
  if [[ -f "$work_dir/bugsinpy_setup.sh" ]]; then
    DONE=false
    until $DONE ;do
    read || DONE=true
       run_setup_all+="$REPLY;"
       echo $REPLY
    done < "$work_dir/bugsinpy_setup.sh"
  fi
  
  IFS=';' read -r -a run_setup <<< "$run_setup_all"

###Run setup.sh
if grep -q '[^[:space:]]' "$work_dir/bugsinpy_requirements.txt"; then
    sed -e '/^\s*#.*$/d' -e '/^\s*$/d' $work_dir/bugsinpy_requirements.txt | xargs -I {} pip install {}
fi

for index in "${!run_setup[@]}"
do
   run_setup_trail=${run_setup[index]} 
   run_setup_now=$(echo $run_setup_trail | sed -e 's/\r//g')
   $run_setup_now
done
  
###Install requirement
if grep -q '[^[:space:]]' "$work_dir/bugsinpy_requirements.txt"; then
    sed -e '/^\s*#.*$/d' -e '/^\s*$/d' $work_dir/bugsinpy_requirements.txt | xargs -I {} pip install {}
fi
deactivate

###Add compile flag
echo "1" > "$work_dir/bugsinpy_compile_flag"